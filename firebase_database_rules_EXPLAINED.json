{
  "rules": {
    "users": {
      ".read": "auth != null",
      ".indexOn": [
        "email",
        "phone",
        "name",
        "role",
        "specialty",
        "isBlocked",
        "isDeleted"
      ],
      "$uid": {
        ".read": "auth != null",
        ".write": "auth.uid == $uid || root.child('users').child(auth.uid).child('role').val() == 'admin'"
      }
    },
    "patients": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "primaryUserId",
        "status"
      ],
      "$patientId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "health_records": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "recordedByUserId",
        "createdAt"
      ],
      "$patientId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "sos_requests": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "userId",
        "status",
        "createdAt",
        "assignedHospitalId"
      ]
    },
    "hospitals": {
      ".read": "auth != null",
      ".write": "auth != null"
    },
    "hospital_notifications": {
      ".write": "auth != null",
      "$hospitalId": {
        ".indexOn": [
          "createdAt",
          "type"
        ]
      }
    },
    "conversations": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "userId",
        "doctorId",
        "updatedAt"
      ],
      "$conversationId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "messages": {
      "$conversationId": {
        ".read": "auth != null",
        ".write": "auth != null",
        ".indexOn": [
          "createdAt",
          "senderId",
          "receiverId",
          "status"
        ]
      }
    },
    "user_conversations": {
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null",
        ".indexOn": [
          "doctorId",
          "createdAt"
        ]
      }
    },
    "doctor_conversations": {
      "$doctorId": {
        ".read": "auth != null",
        ".write": "auth != null",
        ".indexOn": [
          "userId",
          "createdAt"
        ]
      }
    },
    "user_status": {
      "$userId": {
        ".read": "auth != null",
        ".write": "auth != null",
        ".indexOn": [
          "isOnline",
          "lastSeen"
        ]
      }
    },
    "chat_sessions": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$sessionId": {
        "messages": {
          ".indexOn": [
            "createdAt",
            "senderId"
          ]
        }
      }
    },
    "appointments": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "userId",
        "doctorId",
        "status",
        "appointmentTime"
      ]
    },
    "prescriptions": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "patientId",
        "doctorId",
        "createdAt"
      ]
    },
    "reminders": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$uid": {
        ".indexOn": [
          "time",
          "isActive",
          "createdAt"
        ]
      }
    },
    "family_requests": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "fromUserId",
        "toUserId",
        "status",
        "createdAt"
      ]
    },
    "family_members": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$uid": {
        ".indexOn": [
          "memberId",
          "addedAt"
        ]
      }
    },
    "family_groups": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "creatorId",
        "createdAt",
        "memberCount"
      ],
      "$groupId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "family_group_members": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$groupId": {
        ".indexOn": [
          "role",
          "joinedAt"
        ]
      }
    },
    "user_family_groups": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$userId": {
        ".indexOn": [
          "role",
          "joinedAt"
        ]
      }
    },
    "family_group_invitations": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "toUserId",
        "fromUserId",
        "groupId",
        "status",
        "createdAt"
      ]
    },
    "notifications": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$uid": {
        ".indexOn": [
          "isRead",
          "createdAt",
          "type"
        ]
      }
    },
    "knowledge_articles": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "category",
        "publishedAt",
        "authorDoctorId"
      ]
    },
    "forum_threads": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "createdByUserId",
        "createdAt",
        "category"
      ]
    },
    "forum_posts": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "threadId",
        "createdByUserId",
        "createdAt"
      ]
    },
    "pharmacies": {
      ".read": "auth != null",
      ".write": "auth != null"
    },
    "drugs": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "category",
        "name"
      ]
    },
    "orders": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "userId",
        "status",
        "createdAt"
      ]
    },
    "doctors": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "hospitalId",
        "specialty",
        "rating"
      ]
    },
    "doctor_stats": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$doctorId": {
        ".read": "auth != null",
        ".write": "auth != null"
      }
    },
    "reviews": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "doctorId",
        "userId",
        "createdAt",
        "rating"
      ]
    },
    "predictions": {
      ".read": "auth != null",
      ".write": "auth != null",
      ".indexOn": [
        "userId",
        "type",
        "createdAt",
        "riskLevel"
      ],
      "$predictionId": {
        ".read": "auth != null",
        ".write": "auth != null"
      },
      "prescriptions": {
        "$prescriptionId": {
          ".read": "auth != null && (data.child('userId').val() === auth.uid || data.child('doctorId').val() === auth.uid)",
          ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'doctor'",
          ".validate": "newData.hasChildren(['prescriptionId', 'prescriptionCode', 'doctorId', 'userId', 'conversationId', 'createdAt', 'status', 'medications', 'totalAmount', 'diagnosis'])",
          "prescriptionId": {
            ".validate": "newData.isString()"
          },
          "prescriptionCode": {
            ".validate": "newData.isString() && newData.val().matches(/^RX[0-9]{6}[0-9]{3}$/)"
          },
          "doctorId": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          },
          "userId": {
            ".validate": "newData.isString()"
          },
          "conversationId": {
            ".validate": "newData.isString()"
          },
          "createdAt": {
            ".validate": "newData.isNumber()"
          },
          "status": {
            ".validate": "newData.isString() && (newData.val() === 'active' || newData.val() === 'purchased' || newData.val() === 'expired' || newData.val() === 'cancelled')"
          },
          "medications": {
            ".validate": "newData.hasChildren()"
          },
          "totalAmount": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "diagnosis": {
            ".validate": "newData.isString()"
          },
          "notes": {
            ".validate": "newData.isString()"
          }
        }
      },
      "user_prescriptions": {
        "$userId": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": "auth != null && root.child('users').child(auth.uid).child('role').val() === 'doctor'",
          "$prescriptionId": {
            ".validate": "newData.val() === true"
          }
        }
      },
      "doctor_prescriptions": {
        "$doctorId": {
          ".read": "auth != null && auth.uid === $doctorId",
          ".write": "auth != null && auth.uid === $doctorId && root.child('users').child(auth.uid).child('role').val() === 'doctor'",
          "$prescriptionId": {
            ".validate": "newData.val() === true"
          }
        }
      },
      "doctor_reviews": {
        ".read": "auth != null",
        ".indexOn": [
          "createdAt",
          "rating"
        ],
        "$doctorId": {
          ".read": "auth != null",
          ".write": "auth != null",
          "$reviewId": {
            ".validate": "newData.hasChildren(['userId', 'rating', 'createdAt'])",
            "userId": {
              ".validate": "newData.isString() && newData.val() === auth.uid"
            },
            "rating": {
              ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 5"
            },
            "comment": {
              ".validate": "!newData.exists() || newData.isString()"
            },
            "isAnonymous": {
              ".validate": "!newData.exists() || newData.isBoolean()"
            },
            "createdAt": {
              ".validate": "newData.isNumber()"
            }
          }
        }
      },
      "doctor_stats": {
        ".read": "auth != null",
        "$doctorId": {
          ".read": "auth != null",
          ".write": "auth != null && (auth.uid === $doctorId || root.child('users').child(auth.uid).child('role').val() === 'doctor' || root.child('users').child(auth.uid).child('role').val() === 'admin')",
          ".validate": "newData.hasChildren()",
          "totalReviews": {
            ".validate": "!newData.exists() || newData.isNumber()"
          },
          "averageRating": {
            ".validate": "!newData.exists() || newData.isNumber()"
          },
          "totalPatients": {
            ".validate": "!newData.exists() || newData.isNumber()"
          },
          "totalAppointments": {
            ".validate": "!newData.exists() || newData.isNumber()"
          },
          "completedAppointments": {
            ".validate": "!newData.exists() || newData.isNumber()"
          },
          "totalPrescriptions": {
            ".validate": "!newData.exists() || newData.isNumber()"
          },
          "updatedAt": {
            ".validate": "!newData.exists() || newData.isNumber()"
          }
        }
      }
    }
  }
}